

```d2
# 过充保护架构图
direction: right

classes: {
  component: {
    style: {
      fill: "#f5f5f5"
      stroke: "#2B2B2B"
      border-radius: 4
      shadow: true
    }
  }
  flow: {
    style: {
      stroke: "#2B2B2B"
      opacity: 0.7
      stroke-dash: 3 
    }
  }
}

EvseManager: {
  class: component
  
  shape: rectangle
  style.multiple: true
  
  过压保护: {
    获取阈值
    监控电压
    触发保护
  }
}

Charger: {
  class: component
  
  shape: rectangle
  style.multiple: true
  
  过流保护: {
    软件限流
    硬件限流
    错误处理
  }
}

ErrorHandling: {
  class: component
  
  shape: rectangle
  style.multiple: true
  
  错误管理: {
    错误触发
    错误清除
    状态恢复
  }
}

EvseManager -> Charger: 电压/电流监控
Charger -> ErrorHandling: 错误上报
ErrorHandling -> EvseManager: 状态反馈

# 过压保护流程图
direction: down

start: 开始充电 {
  shape: circle
}

voltage_check: 电压检测 {
  shape: diamond
}

threshold: 获取过压阈值 {
  shape: rectangle
  style.fill: "#e1f5fe"
}

protection: 触发过压保护 {
  shape: rectangle 
  style.fill: "#ffebee"
}

error: 错误处理 {
  shape: rectangle
  style.fill: "#fff3e0" 
}

resume: 恢复充电 {
  shape: rectangle
  style.fill: "#e8f5e9"
}

end: 结束 {
  shape: circle
}

start -> voltage_check
voltage_check -> threshold: 电压超过阈值
threshold -> protection: 确认过压
protection -> error: 触发错误
error -> resume: 错误清除
resume -> end
voltage_check -> end: 电压正常

# 过流保护流程图 
direction: down

start2: 开始充电 {
  shape: circle
}

current_monitor: 电流监测 {
  shape: diamond
}

soft_limit: 软件限流 {
  shape: rectangle
  style.fill: "#e1f5fe"
}

hard_limit: 硬件限流 {
  shape: rectangle
  style.fill: "#ffebee"
}

error2: 错误处理 {
  shape: rectangle
  style.fill: "#fff3e0"
}

resume2: 恢复充电 {
  shape: rectangle
  style.fill: "#e8f5e9"
}

end2: 结束 {
  shape: circle
}

start2 -> current_monitor
current_monitor -> soft_limit: 超过软件阈值
soft_limit -> hard_limit: 超过硬件阈值
hard_limit -> error2: 触发错误
error2 -> resume2: 错误清除
resume2 -> end2
current_monitor -> end2: 电流正常
```


```plantuml
@startuml component
skinparam componentStyle uml2
skinparam backgroundColor white
skinparam handwritten false

package "EVerest充电保护系统" {
  [EvseManager] as em
  [Charger] as ch 
  [ErrorHandling] as eh
  
  interface "过压保护" as ovp
  interface "过流保护" as ocp
  interface "错误处理" as err
  
  em -- ovp
  ch -- ocp
  eh -- err
  
  ovp --> ch : 电压监控
  ocp --> eh : 错误上报
  err --> em : 状态反馈
}

note right of em
  实现IEC 61851-23标准
  不同电压等级的过压保护
end note

note right of ch
  软硬件双重过流保护
  实时电流监测
end note

note right of eh
  统一错误处理
  状态管理与恢复
end note
@enduml

@startuml 过压保护时序图
skinparam backgroundColor white
participant EvseManager
participant Charger
participant ErrorHandling

activate EvseManager
EvseManager -> EvseManager: get_over_voltage_threshold()
note right: 根据IEC标准设置阈值

loop 充电过程
  EvseManager -> EvseManager: 监测电压
  alt 电压超过阈值
    EvseManager -> Charger: 中断充电
    activate Charger
    Charger -> ErrorHandling: raise_error()
    activate ErrorHandling
    ErrorHandling -> EvseManager: 进入保护状态
    deactivate ErrorHandling
    deactivate Charger
  end
end

EvseManager -> ErrorHandling: clear_error()
ErrorHandling -> EvseManager: 恢复正常状态
deactivate EvseManager
@enduml

@startuml 过流保护状态图
skinparam backgroundColor white
[*] --> 正常充电

state 正常充电 {
  [*] --> 电流监测
  电流监测 --> 软件限流 : 超过软件阈值
  软件限流 --> 硬件限流 : 超过硬件阈值
  电流监测 --> [*] : 电流正常
}

state 保护状态 {
  硬件限流 --> 错误处理
  错误处理 --> 等待恢复
}

保护状态 --> 正常充电 : clear_error()
正常充电 --> [*]
@enduml

@startuml 过充保护类图
skinparam backgroundColor white
skinparam classAttributeIconSize 0

class EvseManager {
  -ev_max_voltage: float
  -negotiated_max_voltage: double
  +get_over_voltage_threshold(): double
  +wait_powersupply_DC_voltage_reached(): bool
  +powersupply_DC_set(): bool
  +powersupply_DC_off(): void
}

class Charger {
  -max_current: float
  -over_current: bool
  +set_max_current(): bool
  +check_soft_over_current(): void
  +set_overcurrent_limit(): void
}

class ErrorHandling {
  +raise_overcurrent_error(): void
  +clear_overcurrent_error(): void
  +process_error(): void
}

EvseManager --> Charger
Charger --> ErrorHandling
ErrorHandling --> EvseManager

note right of EvseManager::get_over_voltage_threshold
  根据IEC 61851-23标准
  设置不同等级过压阈值
end note

note right of Charger::check_soft_over_current
  软件过流保护实现
  实时监测与限流
end note
@enduml
```